<!-- templates/exploit_form.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lancer un exploit - Toolbox</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .card {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .warning-banner {
            background-color: #ffe0b2;
            border-left: 5px solid #ff9800;
            padding: 15px;
            margin-bottom: 20px;
        }
        .module-info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .nav-tabs .nav-link {
            color: #495057;
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
            color: #0d6efd;
        }
    </style>
</head>
<body>
    {% include 'navbar.html' %}
    
    <div class="container mt-4 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1><i class="bi bi-lightning-charge"></i> Lancer un exploit</h1>
            <a href="/vuln" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Retour
            </a>
        </div>
        
        <div class="warning-banner">
            <h4><i class="bi bi-exclamation-triangle"></i> Attention</h4>
            <p>L'utilisation d'exploits peut être illégale si vous n'avez pas l'autorisation d'exploiter la cible. Utilisez cette fonctionnalité uniquement dans un environnement contrôlé et sur des systèmes pour lesquels vous avez l'autorisation.</p>
        </div>
        
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title mb-0">Détails de l'exploitation</h3>
            </div>
            <div class="card-body">
                <form action="/api/exploit/auto" method="post" id="exploit-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="vuln_id">Vulnérabilité:</label>
                                <input type="text" class="form-control" id="vuln_id" name="vuln_id" value="{{ vuln.id }}" required readonly>
                            </div>
                            
                            <div class="form-group mt-3">
                                <label for="ip">Adresse IP cible:</label>
                                <input type="text" class="form-control" id="ip" name="ip" value="{{ vuln.target }}" required>
                            </div>
                            
                            <div class="form-group mt-3">
                                <label for="port">Port:</label>
                                <input type="number" class="form-control" id="port" name="port" value="{{ vuln.port }}" required>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div id="module-info" class="module-info">
                                <h4>Module Metasploit</h4>
                                <div id="module-loading">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Chargement...</span>
                                    </div>
                                    <span>Vérification du module...</span>
                                </div>
                                <div id="module-details" style="display: none;">
                                    <p id="module-name" class="fw-bold"></p>
                                    <div class="alert alert-info">
                                        <small>Ce module sera utilisé pour exploiter la vulnérabilité. Il a été choisi automatiquement en fonction du type de vulnérabilité.</small>
                                    </div>
                                </div>
                                <div id="module-not-found" style="display: none;">
                                    <div class="alert alert-warning">
                                        Aucun module Metasploit n'a été trouvé automatiquement pour cette vulnérabilité.
                                    </div>
                                    <div class="mt-2">
                                        <label for="manual_module">Spécifier un module manuellement:</label>
                                        <input type="text" class="form-control" id="manual_module" name="manual_module" 
                                               placeholder="ex: auxiliary/scanner/ssl/openssl_ccs">
                                        <small class="form-text text-muted">Entrez le chemin complet du module Metasploit à utiliser</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <ul class="nav nav-tabs mt-4" id="optionsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab">Options de base</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button" role="tab">Options avancées</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="payload-tab" data-bs-toggle="tab" data-bs-target="#payload" type="button" role="tab">Payload</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content p-3 border border-top-0 mb-4" id="optionsTabContent">
                        <!-- Options de base -->
                        <div class="tab-pane fade show active" id="basic" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="option_LHOST">Adresse IP locale (LHOST):</label>
                                        <input type="text" class="form-control" id="option_LHOST" name="option_LHOST" placeholder="192.168.1.100">
                                        <small class="form-text text-muted">Votre adresse IP pour les reverse shells</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="option_LPORT">Port local (LPORT):</label>
                                        <input type="number" class="form-control" id="option_LPORT" name="option_LPORT" value="4444">
                                        <small class="form-text text-muted">Port local pour les reverse shells</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Options avancées -->
                        <div class="tab-pane fade" id="advanced" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="option_VERBOSE">Mode verbeux:</label>
                                        <select class="form-select" id="option_VERBOSE" name="option_VERBOSE">
                                            <option value="">Par défaut</option>
                                            <option value="true">Activé</option>
                                            <option value="false">Désactivé</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="option_TIMEOUT">Timeout (secondes):</label>
                                        <input type="number" class="form-control" id="option_TIMEOUT" name="option_TIMEOUT" placeholder="30">
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="option_SSL">Utiliser SSL/TLS:</label>
                                        <select class="form-select" id="option_SSL" name="option_SSL">
                                            <option value="">Par défaut</option>
                                            <option value="true">Oui</option>
                                            <option value="false">Non</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="option_Proxies">Proxy (http://host:port):</label>
                                        <input type="text" class="form-control" id="option_Proxies" name="option_Proxies" placeholder="">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Options payload -->
                        <div class="tab-pane fade" id="payload" role="tabpanel">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label for="option_PAYLOAD">Payload:</label>
                                        <select class="form-select" id="option_PAYLOAD" name="option_PAYLOAD">
                                            <option value="">Auto (par défaut)</option>
                                            <option value="cmd/unix/reverse_netcat">cmd/unix/reverse_netcat</option>
                                            <option value="generic/shell_reverse_tcp">generic/shell_reverse_tcp</option>
                                            <option value="windows/meterpreter/reverse_tcp">windows/meterpreter/reverse_tcp</option>
                                            <option value="linux/x86/meterpreter/reverse_tcp">linux/x86/meterpreter/reverse_tcp</option>
                                            <option value="php/meterpreter/reverse_tcp">php/meterpreter/reverse_tcp</option>
                                            <option value="java/jsp_shell_reverse_tcp">java/jsp_shell_reverse_tcp</option>
                                        </select>
                                        <small class="form-text text-muted">Le payload à utiliser avec l'exploit</small>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="option_AutoRunScript">Script post-exploitation:</label>
                                        <input type="text" class="form-control" id="option_AutoRunScript" name="option_AutoRunScript" placeholder="post/windows/gather/hashdump">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="option_SESSION">ID de session existante:</label>
                                        <input type="number" class="form-control" id="option_SESSION" name="option_SESSION" placeholder="">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 d-flex gap-2">
                        <button type="submit" class="btn btn-danger" id="exploit-button">
                            <i class="bi bi-lightning-charge"></i> Lancer l'exploit
                        </button>
                        <a href="javascript:history.back()" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Annuler
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Vérification de l'exploitabilité
        document.addEventListener('DOMContentLoaded', function() {
            const vulnId = document.getElementById('vuln_id').value;
            const moduleInfo = document.getElementById('module-info');
            const moduleDetails = document.getElementById('module-details');
            const moduleName = document.getElementById('module-name');
            const moduleLoading = document.getElementById('module-loading');
            const moduleNotFound = document.getElementById('module-not-found');
            const exploitButton = document.getElementById('exploit-button');
            const portField = document.getElementById('port');
            
            // Remplit l'IP locale automatiquement
            fetch('/api/network/local-ip')
                .then(response => response.json())
                .then(data => {
                    if (data.ip) {
                        document.getElementById('option_LHOST').value = data.ip;
                    }
                })
                .catch(error => console.error('Erreur lors de la récupération de l\'IP locale:', error));
            
            // Définit SSL en fonction du port
            if (portField.value === '443') {
                document.getElementById('option_SSL').value = 'true';
            }
            
            // Afficher le chargement
            moduleLoading.style.display = 'block';
            moduleDetails.style.display = 'none';
            moduleNotFound.style.display = 'none';
            
            // Vérifier si la vulnérabilité est exploitable
            fetch('/api/exploit/exploitability', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ vulnerability: vulnId })
            })
            .then(response => response.json())
            .then(data => {
                moduleLoading.style.display = 'none';
                
                if (data.exploitable) {
                    moduleName.textContent = data.module;
                    moduleDetails.style.display = 'block';
                    moduleNotFound.style.display = 'none';
                    
                    // Adapter les options en fonction du module
                    if (data.module.includes('ssl')) {
                        document.getElementById('option_SSL').value = 'true';
                    }
                    
                    if (data.module.includes('dos/http/slowloris')) {
                        document.getElementById('option_TIMEOUT').value = '500';
                    }
                } else {
                    moduleDetails.style.display = 'none';
                    moduleNotFound.style.display = 'block';
                    // Le bouton reste activé
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                moduleLoading.style.display = 'none';
                moduleDetails.style.display = 'none';
                moduleNotFound.style.display = 'block';
            });
            
            // Au changement de port, définir automatiquement SSL
            portField.addEventListener('change', function() {
                if (this.value === '443') {
                    document.getElementById('option_SSL').value = 'true';
                }
            });
        });
    </script>
</body>
</html>
